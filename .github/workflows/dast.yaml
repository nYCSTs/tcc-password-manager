name: DAST

on: workflow_call

defaults:
  run:
    shell: bash

jobs:
  config_git:
    name: 'config_git'
    runs-on: ubuntu-latest

    steps:
      - name: Config GitHub
        run: |
          git config --global user.email "${{secrets.GIT_USER_EMAIL}}"
          git config --global user.name "${{secrets.GIT_USER_NAME}}"

  zap_baseline:
    name: 'zap_baseline_scan'
    runs-on: ubuntu-latest
    needs: config_git

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Config GitHub
        run: |
          git config --global user.email "${{secrets.GIT_USER_EMAIL}}"
          git config --global user.name "${{secrets.GIT_USER_NAME}}"

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          token: ${{ secrets.TOKEN_GIT }}
          docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
          target: 'https://hml-tcc-password-manager.vercel.app'
          cmd_options: '-a'
          allow_issue_writing: 'true'
          artifact_name: 'zap_baseline_scan'

      - name: Upload Zap Baseline Scan Report to Action
        uses: actions/upload-artifact@v4
        with:
          name: zap_baseline_scan
          path: |
            ${{ github.workspace }}/report_html.html
            ${{ github.workspace }}/report_md.md
            ${{ github.workspace }}/report_json.json

      - name: Save ZAP Baseline Scan Reports
        if: always()
        run: |
          git clone "https://x-access-token:${{secrets.TOKEN_GIT}}@github.com/tcc-lucas-dafne/${{secrets.NAME_REPO_GIT}}" ${{secrets.NAME_REPO_GIT}}
          cd ${{secrets.NAME_REPO_GIT}}
          git checkout develop
          current_date=$(date +%Y-%m-%d)
          rm -rf reports/zap_baseline_scan/${current_date} && mkdir -p reports/zap_baseline_scan/${current_date}
          cp -R ${{github.workspace}}/report_html.html reports/zap_baseline_scan/${current_date}/
          cp -R ${{github.workspace}}/report_json.json reports/zap_baseline_scan/${current_date}/
          cp -R ${{github.workspace}}/report_md.md reports/zap_baseline_scan/${current_date}/
          git add .
          git commit -m "Adicionando relatório no repositório ${{ github.event.repository.name }} ${{ github.ref_name }} [skip ci]"
          git push origin develop
          
      - name: Remove ZAP Baseline Reports 
        run: |
          rm report_html.html
          rm report_md.md
          rm report_json.json

  zap_full_scan:    
    name: 'zap_full_scan'
    runs-on: ubuntu-latest
    needs: config_git

    steps:
      - name: Checkout
        uses: actions/checkout@v2
  
      - name: ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          token: ${{ secrets.TOKEN_GIT }}
          docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
          target: 'https://hml-tcc-password-manager.vercel.app'
          cmd_options: >
            - j 
            - a
          allow_issue_writing: 'true'
          artifact_name: 'zap_full_scan'

      - name: Upload Zap Full Scan Report to Action
        uses: actions/upload-artifact@v4
        with:
          name: zap_full_scan
          path: |
            ${{ github.workspace }}/report_html.html
            ${{ github.workspace }}/report_md.md
            ${{ github.workspace }}/report_json.json

      - name: Save ZAP Full Scan Reports
        if: always()
        run: |
          git clone "https://x-access-token:${{secrets.TOKEN_GIT}}@github.com/tcc-lucas-dafne/${{secrets.NAME_REPO_GIT}}" ${{secrets.NAME_REPO_GIT}}
          cd ${{secrets.NAME_REPO_GIT}}
          git checkout develop
          current_date=$(date +%Y-%m-%d)
          rm -rf reports/zap_full_scan/${current_date} && mkdir -p reports/zap_full_scan/${current_date}
          cp -R ${{github.workspace}}/report_html.html reports/zap_full_scan/${current_date}/
          cp -R ${{github.workspace}}/report_json.json reports/zap_full_scan/${current_date}/
          cp -R ${{github.workspace}}/report_md.md reports/zap_full_scan/${current_date}/
          git add .
          git commit -m "Adicionando relatório no repositório ${{ github.event.repository.name }} ${{ github.ref_name }} [skip ci]"
          git push origin develop

      - name: Remove ZAP Full Scan Reports 
        run: |
          rm report_html.html
          rm report_md.md
          rm report_json.json
    
  nikto:
    name: 'nikto'
    runs-on: ubuntu-latest
    needs: config_git

    steps:
      - name: Create nikto report file
        run: |
          touch ${{ github.workspace }}/nikto_out.json
          chmod o+w ${{ github.workspace }}/nikto_out.json
          chmod g+w ${{ github.workspace }}/nikto_out.json

      - name: Find absolute path of nikto_out.json
        id: find_file_path
        run: |
          file_path=$(realpath nikto_out.json)
          echo "FILE_PATH=$file_path" >> $GITHUB_ENV

      - name: Scan with nikto
        uses: thereisnotime/action-nikto@master
        with:
          url: "https://hml-tcc-password-manager.vercel.app/"
          additional_args: "-Option FAILURES=0 -o $FILE_PATH -Format json"

      - name: Upload Nikto Report to Action
        uses: actions/upload-artifact@v4
        with:
          name: nikto-report
          path: ${{ runner.temp }}/nikto_out.json
      
      - name: Save Nikto Report
        if: always()
        run: |
          git clone "https://x-access-token:${{secrets.TOKEN_GIT}}@github.com/tcc-lucas-dafne/${{secrets.NAME_REPO_GIT}}" ${{secrets.NAME_REPO_GIT}}
          cd ${{secrets.NAME_REPO_GIT}}
          git checkout develop
          current_date=$(date +%Y-%m-%d)
          rm -rf reports/nikto/${current_date} && mkdir -p reports/nikto/${current_date}
          cp -R ${{github.workspace}}/nikto_out.json reports/nikto/${current_date}/
          git add .
          git commit -m "Adicionando relatório no repositório ${{ github.event.repository.name }} ${{ github.ref_name }} [skip ci]"
          git push origin develop